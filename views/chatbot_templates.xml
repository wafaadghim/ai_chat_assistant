<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Template principal du chatbot -->
    <template id="chatbot_widget_complete" name="AI Chatbot Widget">
        <div id="ai-chatbot-widget">
            <!-- CSS intÃ©grÃ© -->
            <style>
                #ai-chatbot-widget {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 9999;
                    font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
                }
                
                .ai-chat-bubble {
                    width: 60px;
                    height: 60px;
                    background: linear-gradient(45deg, #714B67, #875A7B);
                    border-radius: 50%;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    box-shadow: 0 2px 20px rgba(113, 75, 103, 0.3);
                    transition: all 0.3s ease;
                    position: relative;
                    border: none;
                }
                
                .ai-chat-bubble:hover {
                    transform: scale(1.1);
                    box-shadow: 0 4px 25px rgba(113, 75, 103, 0.5);
                }
                
                .ai-chat-bubble::before {
                    content: 'ğŸ’¬';
                    font-size: 28px;
                    animation: bounce 2s infinite;
                }
                
                .ai-chat-bubble::after {
                    content: '';
                    position: absolute;
                    bottom: -8px;
                    right: 15px;
                    width: 0;
                    height: 0;
                    border-left: 12px solid transparent;
                    border-right: 12px solid transparent;
                    border-top: 15px solid #714B67;
                    border-radius: 3px;
                }
                
                @keyframes bounce {
                    0%, 20%, 50%, 80%, 100% {
                        transform: translateY(0);
                    }
                    40% {
                        transform: translateY(-3px);
                    }
                    60% {
                        transform: translateY(-2px);
                    }
                }
                
                .ai-chat-window {
                    position: absolute;
                    bottom: 85px;
                    right: 0;
                    width: 380px;
                    height: 550px;
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
                    display: none;
                    flex-direction: column;
                    overflow: hidden;
                    border: 1px solid #e4e6ea;
                    animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                }
                
                .ai-chat-window::before {
                    content: '';
                    position: absolute;
                    bottom: -12px;
                    right: 20px;
                    width: 0;
                    height: 0;
                    border-left: 15px solid transparent;
                    border-right: 15px solid transparent;
                    border-top: 20px solid white;
                    z-index: 10;
                }
                
                .ai-chat-window::after {
                    content: '';
                    position: absolute;
                    bottom: -13px;
                    right: 19px;
                    width: 0;
                    height: 0;
                    border-left: 16px solid transparent;
                    border-right: 16px solid transparent;
                    border-top: 21px solid #e4e6ea;
                    z-index: 9;
                }
                
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px) scale(0.95);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
                
                .ai-chat-header {
                    background: linear-gradient(45deg, #714B67, #875A7B);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 16px 16px 0 0;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .ai-header-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .ai-avatar-container {
                    width: 40px;
                    height: 40px;
                    background: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border: 2px solid white;
                    overflow: hidden;
                }
                
                .ai-avatar-container img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 50%;
                    transition: transform 0.3s ease;
                }
                
                .ai-avatar-container:hover img {
                    transform: scale(1.05);
                }
                
                .ai-header-text h4 {
                    margin: 0;
                    font-size: 16px;
                    font-weight: 600;
                }
                
                .ai-status {
                    font-size: 12px;
                    opacity: 0.9;
                }
                
                .ai-minimize-btn {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 18px;
                    cursor: pointer;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    transition: background-color 0.2s;
                }
                
                .ai-minimize-btn:hover {
                    background-color: rgba(255, 255, 255, 0.2);
                }
                
                .ai-chat-messages {
                    flex: 1;
                    padding: 20px;
                    overflow-y: auto;
                    background: #f8f9fa;
                }
                
                .ai-message-container {
                    display: flex;
                    align-items: flex-end;
                    margin-bottom: 12px;
                    gap: 8px;
                }
                
                .ai-message-container.user {
                    flex-direction: row-reverse;
                    justify-content: flex-start;
                }
                
                .ai-message-container.bot {
                    justify-content: flex-start;
                }
                
                .ai-message-info {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 4px;
                }
                
                .ai-message-container.user .ai-message-info {
                    align-items: flex-end;
                }
                
                .ai-message-container.bot .ai-message-info {
                    align-items: flex-start;
                }
                
                .ai-message-name {
                    font-size: 11px;
                    color: #666;
                    font-weight: 500;
                    margin-bottom: 2px;
                }
                
                .ai-message-avatar {
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                    border: 2px solid #DEE2E6;
                    overflow: hidden;
                    background: white;
                }
                
                .ai-message-avatar img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    border-radius: 50%;
                    transition: transform 0.2s ease;
                }
                
                .ai-message-avatar:hover img {
                    transform: scale(1.1);
                }
                
                .ai-message-container.user .ai-message-avatar {
                    border: 2px solid #714B67;
                }
                
                .ai-message-container.bot .ai-message-avatar {
                    border: 2px solid #875A7B;
                }
                
                .ai-message {
                    margin-bottom: 0;
                    display: flex;
                    align-items: flex-end;
                    gap: 8px;
                }
                
                .ai-message.user {
                    justify-content: flex-end;
                }
                
                .ai-message.bot {
                    justify-content: flex-start;
                }
                
                .ai-message-bubble {
                    max-width: 75%;
                    padding: 12px 16px;
                    border-radius: 18px;
                    font-size: 14px;
                    line-height: 1.4;
                    word-wrap: break-word;
                }
                
                .ai-message.user .ai-message-bubble {
                    background: linear-gradient(45deg, #714B67, #875A7B);
                    color: white;
                    border-bottom-right-radius: 4px;
                    margin-left: auto;
                    position: relative;
                }
                
                .ai-message.user .ai-message-bubble::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    right: -8px;
                    width: 0;
                    height: 0;
                    border-top: 8px solid #714B67;
                    border-right: 8px solid transparent;
                }
                
                .ai-message.bot .ai-message-bubble {
                    background: #f1f3f4;
                    color: #1c1e21;
                    border-bottom-left-radius: 4px;
                    box-shadow: none;
                    position: relative;
                }
                
                .ai-message.bot .ai-message-bubble::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: -8px;
                    width: 0;
                    height: 0;
                    border-top: 8px solid #f1f3f4;
                    border-left: 8px solid transparent;
                }
                
                .ai-quick-actions {
                    padding: 12px 20px;
                    background: #f8f9fa;
                    border-top: 1px solid #e5e7eb;
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
                }
                
                .ai-quick-action {
                    background: white;
                    border: 1px solid #d1d5db;
                    color: #374151;
                    padding: 8px 12px;
                    border-radius: 16px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-weight: 500;
                }
                
                .ai-quick-action:hover {
                    background: linear-gradient(45deg, #714B67, #875A7B);
                    color: white;
                    border-color: transparent;
                    transform: translateY(-1px);
                }
                
                .ai-chat-input-container {
                    padding: 16px 20px;
                    background: white;
                    border-top: 1px solid #e5e7eb;
                    display: flex;
                    gap: 12px;
                    align-items: flex-end;
                }
                
                .ai-chat-input {
                    flex: 1;
                    border: 1px solid #d1d5db;
                    border-radius: 20px;
                    padding: 12px 16px;
                    font-size: 14px;
                    outline: none;
                    resize: none;
                    min-height: 20px;
                    max-height: 120px;
                    font-family: inherit;
                    transition: all 0.2s ease;
                    line-height: 1.5;
                    word-wrap: break-word;
                    overflow-y: auto;
                    white-space: pre-wrap;
                }
                
                .ai-chat-input:focus {
                    border-color: #714B67;
                    box-shadow: 0 0 0 3px rgba(113, 75, 103, 0.1);
                }
                
                .ai-chat-send {
                    background: linear-gradient(45deg, #714B67, #875A7B);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                    flex-shrink: 0;
                    align-self: flex-end;
                }
                
                .ai-chat-send:hover {
                    transform: scale(1.1);
                    box-shadow: 0 4px 12px rgba(113, 75, 103, 0.4);
                }
                
                .ai-chat-send::before {
                    content: 'â¤';
                    font-size: 16px;
                    font-weight: bold;
                }
                
                .ai-typing {
                    padding: 12px 16px;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 18px;
                    border-bottom-left-radius: 6px;
                    font-size: 14px;
                    color: #6b7280;
                    font-style: italic;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                }
                
                /* Scrollbar personnalisÃ©e */
                .ai-chat-messages::-webkit-scrollbar {
                    width: 6px;
                }
                
                .ai-chat-messages::-webkit-scrollbar-track {
                    background: #f1f1f1;
                    border-radius: 3px;
                }
                
                .ai-chat-messages::-webkit-scrollbar-thumb {
                    background: #c1c1c1;
                    border-radius: 3px;
                }
                
                .ai-chat-messages::-webkit-scrollbar-thumb:hover {
                    background: #a8a8a8;
                }
            </style>
            
            <!-- Structure HTML -->
            <div class="ai-chat-bubble" onclick="window.toggleAIChatbot()">
            </div>
            
            <div class="ai-chat-window" id="aiChatWindow">
                <div class="ai-chat-header">
                    <div class="ai-header-content">
                        <div class="ai-avatar-container">
                            <img src="/ai_chat_assistant/static/src/img/user_avatar.svg" alt="AI Assistant" />
                        </div>
                        <div class="ai-header-text">
                            <h4>AI Assistant</h4>
                            <span class="ai-status">En ligne</span>
                        </div>
                    </div>
                    <div class="ai-header-actions">
                        <button class="ai-minimize-btn" onclick="window.closeAIChatbot()" title="Minimize">âˆ’</button>
                    </div>
                </div>
                
                <div class="ai-chat-messages" id="aiChatMessages">
                    <div class="ai-message-container bot">
                        <div class="ai-message-info">
                            <div class="ai-message-name">AI Assistant</div>
                            <div class="ai-message-avatar">
                                <img src="/ai_chat_assistant/static/src/img/user_avatar.svg" alt="AI Assistant" />
                            </div>
                        </div>
                        <div class="ai-message bot">
                            <div class="ai-message-bubble" id="aiWelcomeMessage">
                                Hello! I am AI Assistant. How can I help you?
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="ai-quick-actions" id="aiQuickActions">
                    <div class="ai-quick-action" onclick="window.sendAIQuickMessage('ğŸ“Š Marketing Overview')">ğŸ“Š Overview</div>
                    <div class="ai-quick-action" onclick="window.sendAIQuickMessage('ğŸ“ˆ Campaign Performance')">ğŸ“ˆ Performance</div>
                </div>

                <div class="ai-chat-input-container">
                    <textarea 
                        class="ai-chat-input" 
                        id="aiChatInput" 
                        placeholder="Type your message..."
                        onkeypress="window.handleAIKeyPress(event)"
                        rows="1"></textarea>
                    <button class="ai-chat-send" onclick="window.sendAIMessage()"></button>
                </div>
            </div>
            
            <!-- JavaScript intÃ©grÃ© -->
            <script type="text/javascript">
                <![CDATA[
                // Variables globales pour le chatbot
                window.aiChatbotOpen = false;
                window.aiSessionId = null;
                window.aiDetectedLanguage = 'en'; // Langue par dÃ©faut : anglais
                
                // DÃ©tection automatique de la langue sans interface de changement
                window.detectMessageLanguage = function(message) {
                    const arabicRegex = /[\u0600-\u06FF]/;
                    const frenchWords = ['le', 'la', 'les', 'de', 'du', 'des', 'et', 'est', 'une', 'pour', 'avec', 'sur', 'dans', 'bonjour', 'salut', 'comment', 'quel', 'que'];
                    
                    if (arabicRegex.test(message)) {
                        return 'ar';
                    }
                    
                    const lowerMessage = message.toLowerCase();
                    for (let word of frenchWords) {
                        if (lowerMessage.includes(word)) {
                            return 'fr';
                        }
                    }
                    
                    return 'en'; // Par dÃ©faut anglais
                };
                
                window.toggleAIChatbot = function() {
                    if (window.aiChatbotOpen) {
                        window.closeAIChatbot();
                    } else {
                        window.openAIChatbot();
                    }
                };
                
                window.openAIChatbot = function() {
                    const chatWindow = document.getElementById('aiChatWindow');
                    
                    if (chatWindow) {
                        chatWindow.style.display = 'flex';
                        window.aiChatbotOpen = true;
                        
                        // CrÃ©er une session rÃ©elle si pas encore fait
                        if (!window.aiSessionId || window.aiSessionId.startsWith('fallback_')) {
                            window.createAISession();
                        }
                        
                        setTimeout(function() {
                            const input = document.getElementById('aiChatInput');
                            if (input) input.focus();
                        }, 100);
                    }
                };
                
                window.closeAIChatbot = function() {
                    const chatWindow = document.getElementById('aiChatWindow');
                    if (chatWindow) {
                        chatWindow.style.display = 'none';
                        window.aiChatbotOpen = false;
                    }
                };
                
                window.handleAIKeyPress = function(event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        window.sendAIMessage();
                    }
                };
                
                window.sendAIMessage = function() {
                    const input = document.getElementById('aiChatInput');
                    if (!input) return;
                    
                    const message = input.value.trim();
                    if (!message) return;
                    
                    // DÃ©tection de la langue
                    window.aiDetectedLanguage = window.detectMessageLanguage(message);
                    
                    window.addAIMessage(message, 'user');
                    input.value = '';
                    
                    // Auto-resize
                    input.style.height = 'auto';
                    
                    window.showAITyping();
                    window.processAIMessage(message);
                };
                
                window.sendAIQuickMessage = function(message) {
                    window.addAIMessage(message, 'user');
                    window.showAITyping();
                    window.processAIMessage(message);
                };
                
                window.addAIMessage = function(message, type) {
                    const messagesContainer = document.getElementById('aiChatMessages');
                    if (!messagesContainer) return;
                    
                    const messageContainerDiv = document.createElement('div');
                    messageContainerDiv.className = 'ai-message-container ' + type;
                    
                    // CrÃ©er la section d'information avec nom et avatar
                    const messageInfoDiv = document.createElement('div');
                    messageInfoDiv.className = 'ai-message-info';
                    
                    // CrÃ©er le nom d'utilisateur
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'ai-message-name';
                    nameDiv.textContent = type === 'user' ? 'You' : 'AI Assistant';
                    
                    // CrÃ©er l'avatar avec l'image appropriÃ©e selon le type
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'ai-message-avatar';
                    
                    const avatarImg = document.createElement('img');
                    if (type === 'user') {
                        avatarImg.src = '/ai_chat_assistant/static/src/img/user_avatar.svg';
                        avatarImg.alt = 'User';
                    } else {
                        avatarImg.src = '/ai_chat_assistant/static/src/img/user_avatar.svg';
                        avatarImg.alt = 'AI Assistant';
                    }
                    
                    avatarDiv.appendChild(avatarImg);
                    messageInfoDiv.appendChild(nameDiv);
                    messageInfoDiv.appendChild(avatarDiv);
                    messageContainerDiv.appendChild(messageInfoDiv);
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'ai-message ' + type;
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'ai-message-bubble';
                    bubble.innerHTML = message;
                    
                    messageDiv.appendChild(bubble);
                    messageContainerDiv.appendChild(messageDiv);
                    messagesContainer.appendChild(messageContainerDiv);
                    
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                };
                
                window.processAIMessage = function(message) {
                    // Appel RPC vers le contrÃ´leur Odoo
                    if (typeof odoo !== 'undefined' && odoo.session && odoo.session.rpc) {
                        odoo.session.rpc('/ai_chat/process', 'call', {
                            message: message,
                            session_id: window.aiSessionId,
                            language: window.aiDetectedLanguage
                        }).then(function(result) {
                            window.hideAITyping();
                            
                            if (result.success) {
                                window.addAIMessage(result.response, 'bot');
                                
                                // Afficher les actions rapides si disponibles
                                if (result.quick_actions && result.quick_actions.length > 0) {
                                    window.showQuickActions(result.quick_actions);
                                }
                            } else {
                                window.addAIMessage('DÃ©solÃ©, une erreur est survenue. Veuillez rÃ©essayer.', 'bot');
                            }
                        }).catch(function(error) {
                            console.error('Erreur API:', error);
                            window.hideAITyping();
                            // Fallback avec rÃ©ponses statiques
                            const response = window.getStaticAIResponse(message);
                            window.addAIMessage(response, 'bot');
                        });
                    } else {
                        // Fallback si Odoo RPC n'est pas disponible
                        window.hideAITyping();
                        const response = window.getStaticAIResponse(message);
                        window.addAIMessage(response, 'bot');
                    }
                };

                // Fonction de fallback avec rÃ©ponses statiques
                window.getStaticAIResponse = function(message) {
                    const msg = message.toLowerCase();
                    const language = window.detectMessageLanguage(message);
                    
                    // RÃ©ponses multilingues
                    const responses = {
                        'ar': {
                            greeting: 'ğŸ¤– Ù…Ù…ØªØ§Ø²! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„ØªØ­Ø³ÙŠÙ† Ø­Ù…Ù„Ø§ØªÙƒ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© ÙˆÙ…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡. Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¹Ø±ÙØŸ',
                            overview: 'ğŸ“Š <strong>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</strong><br><br>ğŸ“ˆ <strong>Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong><br>â€¢ 15 Ø­Ù…Ù„Ø© Ù†Ø´Ø·Ø©<br>â€¢ Ù…ØªÙˆØ³Ø· Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØªØ­: 22.5% â¬†ï¸<br>â€¢ Ù…ØªÙˆØ³Ø· Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‚Ø±: 3.2% â¬†ï¸<br>â€¢ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 3.8x ğŸ¯',
                            performance: 'ğŸ“ˆ <strong>ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ù„Ø­Ù…Ù„Ø§Øª</strong><br><br>ğŸ¥‡ <strong>Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø²:</strong><br>â€¢ Ù†Ø´Ø±Ø© Ù†ÙˆÙÙ…Ø¨Ø±: 28% ÙØªØ­ØŒ 4.2% Ù†Ù‚Ø±<br>â€¢ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…Ø¹Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡: 31% ÙØªØ­ØŒ 5.1% Ù†Ù‚Ø±<br><br>âš ï¸ <strong>ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†:</strong><br>â€¢ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ù†ØªØ¬ X: 12% ÙØªØ­',
                            default: 'ğŸ¤– Ø³Ø¤Ø§Ù„ Ù…Ù…ØªØ§Ø²! ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:<br><br>ğŸ“Š <strong>Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª:</strong> Ù…Ù‚Ø§ÙŠÙŠØ³ Ù…ÙØµÙ„Ø©<br>ğŸ“ˆ <strong>Ø§Ù„Ø£Ø¯Ø§Ø¡:</strong> ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ù…Ù„Ø§Øª<br>ğŸ¯ <strong>Ø§Ù„Ù†Ø¸Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©:</strong> Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„<br><br>Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙƒØ´Ø§ÙÙ‡ØŸ'
                        },
                        'fr': {
                            greeting: 'ğŸ¤– Parfait ! Je suis lÃ  pour optimiser vos campagnes marketing et analyser vos performances. Que voulez-vous savoir ?',
                            overview: 'ğŸ“Š <strong>AperÃ§u Marketing Global</strong><br><br>ğŸ“ˆ <strong>Performances actuelles :</strong><br>â€¢ 15 campagnes actives<br>â€¢ Taux d\'ouverture moyen : 22.5% â¬†ï¸<br>â€¢ Taux de clic moyen : 3.2% â¬†ï¸<br>â€¢ ROI global : 3.8x ğŸ¯',
                            performance: 'ğŸ“ˆ <strong>Analyse DÃ©taillÃ©e des Campagnes</strong><br><br>ğŸ¥‡ <strong>Excellentes performances :</strong><br>â€¢ Newsletter Novembre : 28% ouverture, 4.2% clic<br>â€¢ Promo Black Friday : 31% ouverture, 5.1% clic<br><br>âš ï¸ <strong>NÃ©cessite optimisation :</strong><br>â€¢ Email Produit X : 12% ouverture',
                            default: 'ğŸ¤– Excellente question ! Je peux vous accompagner sur :<br><br>ğŸ“Š <strong>Analytics :</strong> MÃ©triques dÃ©taillÃ©es<br>ğŸ“ˆ <strong>Performance :</strong> Rapports de campagnes<br>ğŸ¯ <strong>AperÃ§u :</strong> Vue d\'ensemble<br><br>Que souhaitez-vous explorer ?'
                        },
                        'en': {
                            greeting: 'ğŸ¤– Perfect! I\'m here to optimize your marketing campaigns and analyze performance. What would you like to know?',
                            overview: 'ğŸ“Š <strong>Global Marketing Overview</strong><br><br>ğŸ“ˆ <strong>Current Performance:</strong><br>â€¢ 15 active campaigns<br>â€¢ Average open rate: 22.5% â¬†ï¸<br>â€¢ Average click rate: 3.2% â¬†ï¸<br>â€¢ Global ROI: 3.8x ğŸ¯',
                            performance: 'ğŸ“ˆ <strong>Detailed Campaign Analysis</strong><br><br>ğŸ¥‡ <strong>Excellent performance:</strong><br>â€¢ November Newsletter: 28% open, 4.2% click<br>â€¢ Black Friday Promo: 31% open, 5.1% click<br><br>âš ï¸ <strong>Needs optimization:</strong><br>â€¢ Product X Email: 12% open',
                            default: 'ğŸ¤– Excellent question! I can help you with:<br><br>ğŸ“Š <strong>Analytics:</strong> Detailed metrics<br>ğŸ“ˆ <strong>Performance:</strong> Campaign reports<br>ğŸ¯ <strong>Overview:</strong> Global summary<br><br>What would you like to explore?'
                        }
                    };
                    
                    const lang = responses[language] || responses['en'];
                    
                    if (msg.includes('hello') || msg.includes('hi') || msg.includes('bonjour') || msg.includes('salut') || msg.includes('Ù…Ø±Ø­Ø¨Ø§') || msg.includes('Ø§Ù„Ø³Ù„Ø§Ù…')) {
                        return lang.greeting;
                    }
                    
                    if (msg.includes('aperÃ§u') || msg.includes('overview') || msg.includes('Ù†Ø¸Ø±Ø©')) {
                        return lang.overview;
                    }
                    
                    if (msg.includes('performance') || msg.includes('campagne') || msg.includes('campaign') || msg.includes('Ø£Ø¯Ø§Ø¡') || msg.includes('Ø­Ù…Ù„Ø©')) {
                        return lang.performance;
                    }
                    
                    return lang.default;
                };

                // Fonction pour crÃ©er une vraie session
                window.createAISession = function() {
                    if (typeof odoo !== 'undefined' && odoo.session && odoo.session.rpc) {
                        odoo.session.rpc('/ai_chat/session/create', 'call', {})
                            .then(function(result) {
                                if (result.success) {
                                    window.aiSessionId = result.session_id;
                                    
                                    // Mettre Ã  jour le message de bienvenue
                                    const welcomeElement = document.getElementById('aiWelcomeMessage');
                                    if (welcomeElement && result.welcome_message) {
                                        welcomeElement.innerHTML = result.welcome_message;
                                    }
                                    
                                    console.log('Session crÃ©Ã©e:', window.aiSessionId);
                                }
                            })
                            .catch(function(error) {
                                console.error('Erreur crÃ©ation session:', error);
                                window.aiSessionId = 'fallback_' + Date.now();
                            });
                    } else {
                        // Fallback si Odoo RPC n'est pas disponible
                        window.aiSessionId = 'fallback_' + Date.now();
                        console.log('Session fallback crÃ©Ã©e:', window.aiSessionId);
                    }
                };

                // Fonction pour les actions rapides
                window.executeQuickAction = function(actionType) {
                    if (typeof odoo !== 'undefined' && odoo.session && odoo.session.rpc) {
                        odoo.session.rpc('/ai_chat/quick_action', 'call', {
                            action: actionType
                        }).then(function(result) {
                            if (result.success) {
                                window.addAIMessage(result.response, 'bot');
                            } else {
                                window.addAIMessage('Action non disponible actuellement.', 'bot');
                            }
                        }).catch(function(error) {
                            console.error('Erreur action rapide:', error);
                            window.addAIMessage('Erreur lors de l\'exÃ©cution de l\'action.', 'bot');
                        });
                    } else {
                        // Fallback statique
                        const responses = {
                            'marketing_overview': window.getStaticAIResponse('overview'),
                            'view_campaigns': window.getStaticAIResponse('performance')
                        };
                        const response = responses[actionType] || 'Action non reconnue.';
                        window.addAIMessage(response, 'bot');
                    }
                };

                // Fonction pour afficher les actions rapides
                window.showQuickActions = function(actions) {
                    const messagesContainer = document.getElementById('aiChatMessages');
                    if (!messagesContainer || !actions.length) return;
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'ai-quick-actions-inline';
                    actionsDiv.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e9ecef;';
                    
                    actions.forEach(function(action) {
                        const actionBtn = document.createElement('button');
                        actionBtn.textContent = action.text;
                        actionBtn.onclick = function() {
                            window.executeQuickAction(action.action);
                            actionsDiv.remove();
                        };
                        actionBtn.style.cssText = 'background: linear-gradient(45deg, #714B67, #875A7B); color: white; border: none; padding: 8px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; transition: all 0.2s ease;';
                        actionBtn.onmouseover = function() { this.style.transform = 'scale(1.05)'; };
                        actionBtn.onmouseout = function() { this.style.transform = 'scale(1)'; };
                        
                        actionsDiv.appendChild(actionBtn);
                    });
                    
                    messagesContainer.appendChild(actionsDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                };
                
                window.showAITyping = function() {
                    const messagesContainer = document.getElementById('aiChatMessages');
                    if (!messagesContainer) return;
                    
                    const typingMessages = {
                        'ar': 'Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙƒØªØ¨...',
                        'fr': 'Assistant IA tape...',
                        'en': 'AI Assistant typing...'
                    };
                    
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'ai-message bot';
                    typingDiv.id = 'ai-typing-indicator';
                    
                    const bubble = document.createElement('div');
                    bubble.className = 'ai-typing';
                    bubble.innerHTML = typingMessages[window.aiDetectedLanguage] || typingMessages['en'];
                    
                    typingDiv.appendChild(bubble);
                    messagesContainer.appendChild(typingDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                };
                
                window.hideAITyping = function() {
                    const typing = document.getElementById('ai-typing-indicator');
                    if (typing) {
                        typing.remove();
                    }
                };
                
                // Auto-resize textarea
                document.addEventListener('DOMContentLoaded', function() {
                    const textarea = document.getElementById('aiChatInput');
                    if (textarea) {
                        function autoResize() {
                            textarea.style.height = 'auto';
                            
                            const scrollHeight = textarea.scrollHeight;
                            const maxHeight = 120;
                            const minHeight = 20;
                            
                            if (scrollHeight > maxHeight) {
                                textarea.style.height = maxHeight + 'px';
                                textarea.style.overflowY = 'auto';
                            } else if (scrollHeight < minHeight) {
                                textarea.style.height = minHeight + 'px';
                                textarea.style.overflowY = 'hidden';
                            } else {
                                textarea.style.height = scrollHeight + 'px';
                                textarea.style.overflowY = 'hidden';
                            }
                        }
                        
                        textarea.addEventListener('input', autoResize);
                        autoResize();
                        
                        textarea.addEventListener('keydown', function(event) {
                            if (event.key === 'Enter' && !event.shiftKey) {
                                event.preventDefault();
                                window.sendAIMessage();
                            }
                        });
                        
                        textarea.addEventListener('keyup', function() {
                            setTimeout(autoResize, 0);
                        });
                    }
                });
                
                console.log('AI Chat Assistant Loaded Successfully!');
                ]]>
            </script>
        </div>
    </template>
    
    <!-- Injection du chatbot dans l'interface web -->
    <template id="inject_chatbot" inherit_id="web.layout" name="Inject AI Chatbot">
        <xpath expr="//body" position="inside">
            <t t-call="ai_chat_assistant.chatbot_widget_complete"/>
        </xpath>
    </template>

</odoo>